<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NPS Prognose Rechner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root { --pad: clamp(12px, 3vw, 18px); }

    body {
      background: #f8f9fa;
      font-family: system-ui, sans-serif;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .container {
      width: min(430px, 100%);
      max-width: 100vw;
      margin: 0 auto;
      padding: var(--pad);
      padding-top: max(1.2rem, env(safe-area-inset-top));
    }

    h2 { font-size: 1.5rem; margin-bottom: 1.2rem; }
    .form-label { font-size: 1.05rem; }

    .form-control, .form-select {
      font-size: 16px;
      min-height: 48px;
      padding: 0.7rem 0.8rem;
    }

    input, select, button { font-size: 16px; }

    .btn-primary {
      font-size: 16px;
      min-height: 52px;
      padding: 0.85rem 0;
      border-radius: 0.7rem;
      margin-top: 0.2rem;
    }

    .mb-3 { margin-bottom: 0.85rem !important; }

    .card {
      border-radius: 1.1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .table-responsive { overflow-x: auto; }
    .table { font-size: 0.97em; }
    .table th, .table td { padding: 0.45rem 0.3rem; }

    .text-muted.small, .text-muted.small.mt-1 { font-size: 0.93em !important; }

    .kpi {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1.1;
      margin-left: 0.5rem;
    }

    details summary {
      cursor: pointer;
      user-select: none;
      padding: 0.2em 0;
      margin-bottom: 0.5em;
    }

    @media (max-width: 600px) {
      .container { width: 100vw; max-width: 100vw; padding-left: var(--pad); padding-right: var(--pad); }
      h2 { font-size: 1.18rem; }
      .form-label { font-size: 0.98rem; }
      .form-control, .form-select { font-size: 16px; min-height: 48px; padding: 0.6rem 0.7rem; }
      .btn-primary {
        font-size: 16px;
        min-height: 52px;
        padding: 0.7rem 0;
        position: sticky;
        bottom: 10px;
        z-index: 10;
        box-shadow: 0 8px 24px rgba(0,0,0,.12);
      }
      .card { border-radius: 0.7rem; }
      .table { font-size: 0.93em; }
      body, .container { padding-bottom: 80px; }
    }

    /* ===== Ad Overlay ===== */
    #adOverlay {
      position: fixed;
      z-index: 9999;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;              /* IMPORTANT: hidden by default */
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #adOverlay .ad-content {
      background: #fff;
      padding: 1.4rem 1.1rem;
      border-radius: 1.2rem;
      box-shadow: 0 4px 32px rgba(0,0,0,0.18);
      text-align: center;
      max-width: 92vw;
      width: 420px;
      max-height: 82vh;
      position: relative;
      overflow: auto;
    }

    #adOverlay .ad-close {
      display: block;
      position: absolute;
      top: 0.35rem;
      right: 0.6rem;
      font-size: 2rem;
      line-height: 1;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 2;
    }

    #adOverlay .ad-close:active { color: #c00; }

    #adOverlay .ad-countdown {
      font-size: 1.05rem;
      font-weight: 700;
      margin: 0.8rem 0 0.45rem 0;
    }

    #adOverlay .ad-progress {
      width: 100%;
      height: 12px;
      background: #eee;
      border-radius: 6px;
      margin: 0.9rem 0 0.2rem 0;
      overflow: hidden;
      position: relative;
    }

    #adOverlay .ad-progress-bar {
      height: 100%;
      width: 100%;
      transition: width 1s linear;
      background: linear-gradient(90deg, #0d6efd 0%, #198754 100%);
    }

    /* Ad slot sizing helper (optional) */
    .ad-slot {
      display: block;
      width: 100%;
      min-height: 220px;
      margin: 0.7rem 0 0.2rem 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="mb-4 text-center">NPS Prognose Rechner</h2>

    <div class="card p-3">
      <form id="npsForm">
        <div class="mb-3">
          <label for="totalSurveys" class="form-label">Gesamtbefragungen</label>
          <input type="number" class="form-control" id="totalSurveys" min="0" required>
        </div>

        <div class="mb-3">
          <label for="promoters" class="form-label">Promotoren</label>
          <input type="number" class="form-control" id="promoters" min="0" required>
        </div>

        <div class="mb-3">
          <label for="detractors" class="form-label">Detraktoren</label>
          <input type="number" class="form-control" id="detractors" min="0" required>
        </div>

        <div class="mb-3">
          <label for="workType" class="form-label">Arbeitszeitmodell</label>
          <select class="form-select" id="workType" required>
            <option value="8" selected>Vollzeit (8 h/Tag)</option>
            <option value="6.5">Teilzeit (6,5 h/Tag)</option>
            <option value="6">Teilzeit (6 h/Tag)</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="productiveHours" class="form-label">Produktivstunden (bisher)</label>
          <input type="number" class="form-control" id="productiveHours" min="1" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Restzeit-Eingabe</label>
          <select class="form-select" id="restType" onchange="toggleRestInput()">
            <option value="tage" selected>Verbleibende Arbeitstage</option>
            <option value="stunden">Verbleibende Produktivstunden</option>
          </select>
        </div>

        <div class="mb-3" id="daysLeftDiv">
          <label for="daysLeft" class="form-label">Verbleibende Arbeitstage</label>
          <input type="number" class="form-control" id="daysLeft" min="0" required>
        </div>

        <div class="mb-3" id="hoursLeftDiv" style="display:none;">
          <label for="hoursLeft" class="form-label">Verbleibende Produktivstunden</label>
          <input type="number" class="form-control" id="hoursLeft" min="0">
        </div>

        <div class="mb-3">
          <label for="targetNps" class="form-label">Ziel-NPS</label>
          <input type="number" class="form-control" id="targetNps" min="-100" max="100" required>
        </div>

        <!-- IMPORTANT: ad-trigger class -->
        <button type="submit" class="btn btn-primary w-100 ad-trigger">Berechnen</button>
      </form>
    </div>

    <div id="results" class="mt-4" style="display:none;"></div>
  </div>

  <!-- Ad Container -->
  <div id="ad-container"></div>
  </div>

  <!-- ===== Ad Overlay (in-page, no new tab) ===== -->
  <div id="adOverlay" aria-hidden="true">
    <div class="ad-content">
      <button class="ad-close" id="closeAd" type="button" aria-label="Werbung schließen">&times;</button>
      <h5 class="mb-2">Werbung</h5>

      <!-- AdProvider Slot -->
      <ins id="adIns" class="eas6a97888e33 ad-slot" data-zoneid="5800172"></ins>

      <div class="ad-countdown">
        Bitte warten… <span id="adTimer">5</span>s
      </div>

      <div class="ad-progress">
        <div class="ad-progress-bar" id="adProgress"></div>
      </div>

      <div class="text-muted small mt-2">
        Nach der Werbung werden die Ergebnisse angezeigt.
      </div>
    </div>
  </div>

  <!-- Load AdProvider script ONCE -->
  <script async type="application/javascript" src="https://a.pemsrv.com/ad-provider.js"></script>

  <script>
    // ===== Validation helpers (from your original) =====
    document.getElementById("totalSurveys").addEventListener("blur", function() {
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");
      const minGes = pro + det;
      if ((parseInt(gesInput.value, 10) || 0) < minGes) {
        gesInput.value = minGes;
        gesInput.setCustomValidity("");
      }
    });

    function checkGesValid() {
      const ges = parseInt(document.getElementById("totalSurveys").value, 10) || 0;
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");

      if (ges < pro + det) {
        gesInput.setCustomValidity("Gesamtbefragungen darf nicht kleiner als Promotoren + Detraktoren sein.");
        gesInput.reportValidity();
        return false;
      } else {
        gesInput.setCustomValidity("");
        return true;
      }
    }

    function adjustGesIfNeeded() {
      const pro = parseInt(document.getElementById("promoters").value, 10) || 0;
      const det = parseInt(document.getElementById("detractors").value, 10) || 0;
      const gesInput = document.getElementById("totalSurveys");
      const ges = parseInt(gesInput.value, 10) || 0;
      const minGes = pro + det;
      if (ges < minGes) {
        gesInput.value = minGes;
        gesInput.setCustomValidity("");
      }
    }

    document.getElementById("totalSurveys").addEventListener("input", checkGesValid);
    document.getElementById("promoters").addEventListener("input", function() {
      adjustGesIfNeeded();
      checkGesValid();
    });
    document.getElementById("detractors").addEventListener("input", function() {
      adjustGesIfNeeded();
      checkGesValid();
    });

    function toggleRestInput() {
      const hverInput = document.getElementById('hoursLeft');
      const dverInput = document.getElementById('daysLeft');
      const hverDiv = document.getElementById('hoursLeftDiv');
      const dverDiv = document.getElementById('daysLeftDiv');
      const restType = document.getElementById('restType').value;

      if (restType === 'tage') {
        dverDiv.style.display = '';
        hverDiv.style.display = 'none';
        dverInput.required = true;
        hverInput.required = false;
      } else {
        dverDiv.style.display = 'none';
        hverDiv.style.display = '';
        dverInput.required = false;
        hverInput.required = true;
      }
    }

    // ===== NPS logic (from your original, unchanged) =====
    function generateScenarios(Pro, Det, Pas, zBef, zNPS, dver=0) {
      const scenarios = [];
      for (let fPro = 0; fPro <= zBef; fPro++) {
        for (let fDet = 0; fDet <= zBef - fPro; fDet++) {
          let fPas = zBef - fPro - fDet;
          if (fPas < 0) continue;

          const tPro = Pro + fPro;
          const tDet = Det + fDet;
          const tPas = Pas + fPas;
          const tGes = tPro + tDet + tPas;

          const tNPSraw = tGes > 0 ? ((tPro - tDet) / tGes) * 100 : 0;
          if (tNPSraw >= zNPS && tNPSraw < zNPS + 1) {
            scenarios.push({
              fPro, fPas, fDet,
              tPro, tPas, tDet,
              tNPS: Math.round(tNPSraw),
              tNPSraw,
              _zBef: zBef
            });
            if (scenarios.length >= 10) return scenarios;
          }
        }
      }
      return scenarios;
    }

    function npsColor(nps, target) {
      if (nps >= target) return '#198754';
      if (nps >= target - 10) return '#ffc107';
      return '#dc3545';
    }

    const form = document.getElementById('npsForm');
    const results = document.getElementById('results');

    function calculateNPS() {
      const Pro = parseInt(document.getElementById('promoters').value, 10);
      const Det = parseInt(document.getElementById('detractors').value, 10);
      const Ges = parseInt(document.getElementById('totalSurveys').value, 10);
      const Pas = Ges - Pro - Det;

      const hbis = parseFloat(document.getElementById('productiveHours').value);
      const ZeitMod = parseFloat(document.getElementById('workType').value);
      const d = hbis / ZeitMod;

      let dver;
      let hver;
      const restType = document.getElementById('restType').value;
      if (restType === 'tage') {
        dver = parseInt(document.getElementById('daysLeft').value, 10);
        hver = dver * ZeitMod;
      } else {
        hver = parseFloat(document.getElementById('hoursLeft').value);
        dver = hver / ZeitMod;
      }

      const zNPS = parseInt(document.getElementById('targetNps').value, 10);

      const tGes = Pro + Det + Pas;
      const tNPS = tGes > 0 ? Math.round(((Pro - Det) / tGes) * 100) : 0;

      const dBef = d > 0 ? (tGes / d) : 0;
      const zBef = Math.round(dBef * dver);

      const schwankung = 0.3;
      const minFuture = Math.max(0, Math.round(zBef * (1 - schwankung)));
      const maxFuture = Math.round(zBef * (1 + schwankung));

      results.innerHTML = `
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Ergebnisse</h5>
            <div class="kpi" style="color:${npsColor(tNPS, zNPS)}">${tNPS}</div>
          </div>
          <div><b>Durchschnittliche Befragungen/Tag:</b> ${dBef.toFixed(2)}</div>
          <div><b>Erwartete zukünftige Befragungen (±30%):</b> geschätzt: ${minFuture} bis ${maxFuture}</div>
          <div><b>Ziel-NPS:</b> ${zNPS}</div>
        </div>
      `;

      let filteredScenarios = [];
      for (let ef = minFuture; ef <= maxFuture; ef++) {
        const scenarios = generateScenarios(Pro, Det, Pas, ef, zNPS, dver);
        filteredScenarios = filteredScenarios.concat(scenarios);
      }

      let efExtra = maxFuture + 1;
      while (filteredScenarios.length < 10 && efExtra <= maxFuture + 20) {
        const scenarios = generateScenarios(Pro, Det, Pas, efExtra, zNPS, dver);
        filteredScenarios = filteredScenarios.concat(scenarios);
        efExtra++;
      }

      filteredScenarios = filteredScenarios.slice(0, 25);

      let scenarioTable = `<div class="card p-3">
        <h6 class="mb-2">Szenarien für Ziel-NPS</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle text-center mb-0" style="font-size:0.95em;">
            <thead>
              <tr>
                <th>#</th>
                <th>Befr.</th>
                <th>+Pro<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>+Pas<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>+Det<br><span style='font-weight:normal'>(/Tag)</span></th>
                <th>NPS</th>
              </tr>
            </thead>
            <tbody>`;

      if (filteredScenarios.length === 0) {
        scenarioTable += `<tr>
          <td colspan="6" class="text-muted">
            Keine Szenarien gefunden, bei denen der Ziel-NPS exakt erreicht wird.<br>
            Bitte überprüfe die Eingaben oder wähle einen anderen Ziel-NPS.
          </td>
        </tr>`;
      } else {
        filteredScenarios.forEach((s, idx) => {
          let proPerDayVal = dver > 0 && typeof s.fPro === 'number' ? (s.fPro / dver).toFixed(2) : '-';
          let pasPerDayVal = dver > 0 && typeof s.fPas === 'number' ? (s.fPas / dver).toFixed(2) : '-';
          let detPerDayVal = dver > 0 && typeof s.fDet === 'number' ? (s.fDet / dver).toFixed(2) : '-';
          scenarioTable += `<tr>
            <td>${idx+1}</td>
            <td>${s._zBef}</td>
            <td>${s.fPro}<br><span style='font-size:0.85em;color:#888;'>(${proPerDayVal})</span></td>
            <td>${s.fPas}<br><span style='font-size:0.85em;color:#888;'>(${pasPerDayVal})</span></td>
            <td>${s.fDet}<br><span style='font-size:0.85em;color:#888;'>(${detPerDayVal})</span></td>
            <td style="color:${npsColor(s.tNPSraw, zNPS)}">${s.tNPSraw.toFixed(1)}</td>
          </tr>`;
        });
      }

      scenarioTable += `</tbody></table></div>
        <div class="text-muted small mt-1">Nur Szenarien, bei denen der Ziel-NPS exakt erreicht wird.</div>
      </div>`;

      results.innerHTML += `
        <details class="mt-3">
          <summary class="fw-semibold">Szenarien anzeigen</summary>
          ${scenarioTable}
        </details>
      `;

      results.style.display = 'block';
    }

    // ===== Ad overlay flow (Ad first, then results) =====
    const overlay = document.getElementById('adOverlay');
    const closeBtn = document.getElementById('closeAd');
    const timerEl = document.getElementById('adTimer');
    const progressEl = document.getElementById('adProgress');

    const AD_SECONDS = 5;

    function serveAdProvider() {
      // Trigger an in-page serve when overlay opens
      try {
        (window.AdProvider = window.AdProvider || []).push({ serve: {} });
      } catch (e) {
        // If provider not ready yet, ignore; countdown will still proceed.
      }
    }

    function showAdThenCalculate() {
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');

      // Start / refresh ad request
      serveAdProvider();

      let seconds = AD_SECONDS;
      timerEl.textContent = seconds;
      progressEl.style.width = '100%';

      const tick = () => {
        seconds--;
        timerEl.textContent = Math.max(0, seconds);
        progressEl.style.width = (Math.max(0, seconds) / AD_SECONDS * 100) + '%';

        if (seconds <= 0) {
          clearInterval(interval);
          closeAdAndCalculate();
        }
      };

      const interval = setInterval(tick, 1000);

      closeBtn.onclick = () => {
        clearInterval(interval);
        closeAdAndCalculate();
      };
    }

    function closeAdAndCalculate() {
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
      calculateNPS();
      // Ad-Code direkt nach Berechnen ausführen
      // Ad-Script nur einmal einfügen
      if (!document.getElementById('ad-provider-script')) {
        var s = document.createElement('script');
        s.async = true;
        s.type = 'application/javascript';
        s.src = 'https://a.pemsrv.com/ad-provider.js';
        s.id = 'ad-provider-script';
        document.body.appendChild(s);
      }
      var adContainer = document.getElementById('ad-container');
      adContainer.innerHTML = '<ins class="eas6a97888e33" data-zoneid="5800172"></ins>';
      var adScript = document.createElement('script');
      adScript.innerHTML = '(AdProvider = window.AdProvider || []).push({"serve": {}});';
      adContainer.appendChild(adScript);

    }

    // Intercept submit: show ad first, then calculate
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (!checkGesValid()) return;
      results.style.display = 'none';
      showAdThenCalculate();
    });
  </script>
</body>
</html>
